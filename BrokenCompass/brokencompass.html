<div class="character-sheet">

    <div class="row">
        <div class="col-7 character-details">

            <div class="flex">
                <label>I am</label>
                <input type="text" class="transparent" name="attr_character_name" title="@{character_name}" spellcheck="false">
            </div>

            <div class="flex">
                <label>Call me if you need a</label>
                <input type="text" class="transparent">
            </div>

            <div class="flex center-inputs">
                <label>Place I call home</label>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Heritage</p>
                </div>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Homeland</p>
                </div>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Workplace</p>
                </div>
            </div>

            <div class="input-with-subtext center-inputs">
                <input type="text" class="transparent">
                <p>Words to live by</p>
            </div>

            <label class="secret-roll"><input type="checkbox" value="/w gm" name="attr_secret_roll"> <span data-i18n="make-the-roll-secret">Make the roll secret</span></label>
        </div>
        <div class="col-5">
            <input type="text">
        </div>
    </div>

    <div class="row">
        <div class="col-4">
            <div class="attribute-box">
                <div class="attribute-label">


                    <button type="action" name="act_roll" data-i18n="action" data-attribute="action" data-skill="">Action</button>

                    <input type="hidden" name="attr_action_calc" class="bar-calc-view" value="0">
                    <label class="diamond-checkbox" for="action_value_1">
                        <input class="bar-input" type="checkbox" name="attr_action" id="action_value_1" value="1" />
                        <span class="icon-diamond"></span>
                    </label>
                    <label class="diamond-checkbox diamond-up" for="action_value_2">
                        <input class="bar-input" type="checkbox" name="attr_action" id="action_value_2" value="2" />
                        <span class="icon-diamond"></span>
                    </label>
                    <label class="diamond-checkbox" for="action_value_3">
                        <input class="bar-input" type="checkbox" name="attr_action" id="action_value_3" value="3" />
                        <span class="icon-diamond"></span>
                    </label>
                </div>
                <div class="skill-box">
                    <div class="skill-label">
                        <button type="roll" name="fight"
                            value="@{secret_roll} &{template:brokencompass} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{name=^{dice-pool}}} {{roll-name=^{fight} }} {{base-dice=[[@{action_calc} + @{fight_calc} - @{action_modifier} + ?{Modifiers|0} ]] }} {{base-roll-one=[[1d6]] }} {{base-roll-two=[[1d6]] }} {{base-roll-three=[[1d6]] }} {{base-roll-four=[[1d6]] }} {{base-roll-five=[[1d6]] }}  {{base-roll-six=[[1d6]] }} {{base-roll-seven=[[1d6]] }} {{base-roll-eight=[[1d6]] }} {{base-roll-nine=[[1d6]] }} {{base-roll-ten=[[1d6]] }} {{base-roll-eleven=[[1d6]] }} {{base-roll-twelve=[[1d6]] }} {{base-roll-thirteen=[[1d6]] }} {{base-roll-fourteen=[[1d6]] }} {{base-roll-fifteen=[[1d6]] }}" data-i18n="fight">Fight</button>
						<button type="action" name="act_roll" data-i18n="action" data-attribute="action" data-skill="fight">Fight</button>

                        <input type="hidden" name="attr_fight_calc" class="bar-calc-view" value="0">
                        <label class="diamond-checkbox" for="fight_value_1">
                            <input class="bar-input" type="checkbox" name="attr_fight" id="fight_value_1" value="1" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox diamond-up" for="fight_value_2">
                            <input class="bar-input" type="checkbox" name="attr_fight" id="fight_value_2" value="2" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox" for="fight_value_3">
                            <input class="bar-input" type="checkbox" name="attr_fight" id="fight_value_3" value="3" />
                            <span class="icon-diamond"></span>
                        </label>
                    </div>

                    <div class="skill-label">
                        <button type="roll" name="leadership"
                            value="@{secret_roll} &{template:brokencompass} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{name=^{dice-pool}}} {{roll-name=^{leadership} }} {{base-dice=[[@{action_calc} + @{leadership_calc} - @{action_modifier} + ?{Modifiers|0} ]] }} {{base-roll-one=[[1d6]] }} {{base-roll-two=[[1d6]] }} {{base-roll-three=[[1d6]] }} {{base-roll-four=[[1d6]] }} {{base-roll-five=[[1d6]] }}  {{base-roll-six=[[1d6]] }} {{base-roll-seven=[[1d6]] }} {{base-roll-eight=[[1d6]] }} {{base-roll-nine=[[1d6]] }} {{base-roll-ten=[[1d6]] }} {{base-roll-eleven=[[1d6]] }} {{base-roll-twelve=[[1d6]] }} {{base-roll-thirteen=[[1d6]] }} {{base-roll-fourteen=[[1d6]] }} {{base-roll-fifteen=[[1d6]] }}" data-i18n="leadership">leadership</button>
                        <input type="hidden" name="attr_leadership_calc" class="bar-calc-view" value="0">
                        <label class="diamond-checkbox" for="leadership_value_1">
                            <input class="bar-input" type="checkbox" name="attr_leadership" id="leadership_value_1" value="1" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox diamond-up" for="leadership_value_2">
                            <input class="bar-input" type="checkbox" name="attr_leadership" id="leadership_value_2" value="2" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox" for="leadership_value_3">
                            <input class="bar-input" type="checkbox" name="attr_leadership" id="leadership_value_3" value="3" />
                            <span class="icon-diamond"></span>
                        </label>
                    </div>

                    <div class="skill-label">
                        <button type="roll" name="stunt"
                            value="@{secret_roll} &{template:brokencompass} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{name=^{dice-pool}}} {{roll-name=^{stunt} }} {{base-dice=[[@{action_calc} + @{stunt_calc} - @{action_modifier} + ?{Modifiers|0} ]] }} {{base-roll-one=[[1d6]] }} {{base-roll-two=[[1d6]] }} {{base-roll-three=[[1d6]] }} {{base-roll-four=[[1d6]] }} {{base-roll-five=[[1d6]] }}  {{base-roll-six=[[1d6]] }} {{base-roll-seven=[[1d6]] }} {{base-roll-eight=[[1d6]] }} {{base-roll-nine=[[1d6]] }} {{base-roll-ten=[[1d6]] }} {{base-roll-eleven=[[1d6]] }} {{base-roll-twelve=[[1d6]] }} {{base-roll-thirteen=[[1d6]] }} {{base-roll-fourteen=[[1d6]] }} {{base-roll-fifteen=[[1d6]] }}" data-i18n="stunt">stunt</button>
                        <input type="hidden" name="attr_stunt_calc" class="bar-calc-view" value="0">
                        <label class="diamond-checkbox" for="stunt_value_1">
                            <input class="bar-input" type="checkbox" name="attr_stunt" id="stunt_value_1" value="1" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox diamond-up" for="stunt_value_2">
                            <input class="bar-input" type="checkbox" name="attr_stunt" id="stunt_value_2" value="2" />
                            <span class="icon-diamond"></span>
                        </label>
                        <label class="diamond-checkbox" for="stunt_value_3">
                            <input class="bar-input" type="checkbox" name="attr_stunt" id="stunt_value_3" value="3" />
                            <span class="icon-diamond"></span>
                        </label>
                    </div>

                    <input type="text" name="attr_action_modifier" value="0">
                    
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="attr_pair_one" value="0">
    <input type="hidden" name="attr_pair_two" value="0">
    <input type="hidden" name="attr_pair_three" value="0">
    <input type="hidden" name="attr_pair_four" value="0">
    <input type="hidden" name="attr_pair_five" value="0">
    <input type="hidden" name="attr_pair_six" value="0">

    <input type="hidden" name="attr_null_calc" value="0">
</div>



<!-- Roll Templates -->

<rolltemplate class="sheet-rolltemplate-brokencompass">
	<div class="template-wrap">
		<div class="template-header">
			{{#character_name}}
			{{#character_id}}[{{character_name}}](https://journal.roll20.net/character/{{character_id}}){{/character_id}}
			{{^character_id}}{{character_name}}{{/character_id}}
			{{/character_name}}
		</div>

		<div class="template-subtitle">
			{{roll-name}}
		</div>

		<h4>Result = {{baseDice}}</h4>

		<h4>Dices = {{dices}}</h4>

		<label class="template-label">Equal dice:</label>

		{{#rollGreater() computed::pair_of_one 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_one}}">{{computed::pair_of_one}} x 1</div>
		</div>
		{{/rollGreater() computed::pair_of_one 1}}

		{{#rollGreater() computed::pair_of_two 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_two}}">{{pair_two}} x 2</div>
		</div>
		{{/rollGreater() computed::pair_of_two 1}}

		{{#rollGreater() computed::pair_of_three 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_three}}">{{pair_three}} x 3</div>
		</div>
		{{/rollGreater() computed::pair_of_three 1}}

		{{#rollGreater() computed::pair_of_four 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_four}}">{{pair_four}} x 4</div>
		</div>
		{{/rollGreater() computed::pair_of_four 1}}

		{{#rollGreater() computed::pair_of_five 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_five}}">{{pair_five}} x 5</div>
		</div>
		{{/rollGreater() computed::pair_of_five 1}}

		{{#rollGreater() computed::pair_of_six 1}}
		<div class="template-grid-item">
			<div class="template-roll-between template-roll-between--{{pair_six}}">{{pair_six}} x 6</div>
		</div>
		{{/rollGreater() computed::pair_of_six 1}}

		</div>
	</div>
</rolltemplate>

<script type="text/worker">


	const stats = ["action", "fight", "leadership", "stunt"];

	stats.forEach(stat => {
		on(`change:${stat}`, () => {
			getAttrs([stat], values => {
				const stat_base = values[stat]; 
				
				getAttrs([`${stat}_calc`], function(test) {
					setAttrs({
						[`${stat}_calc`]: stat_base
					}); 
				});
				
			});
		});
	});

	

    on('clicked:roll', (info) => {
		var attribute = info.htmlAttributes['data-attribute'];
		var skill = info.htmlAttributes['data-skill'];
		var rollName = attribute;

		if (skill == '') {
			skill = 'null';
		} else {
			rollName = skill;
		}

		const roll = '@{secret_roll} &{template:brokencompass} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{name=^{dice-pool}}} {{roll-name=^{'+rollName+'} }} {{baseDice=[[ @{'+attribute+'_calc} + @{'+skill+'_calc} + @{'+attribute+'_modifier} + ?{Modifiers|0} ]] }} {{dices=[[(@{'+attribute+'_calc} + @{'+skill+'_calc} + @{'+attribute+'_modifier} + ?{Modifiers|0})d6]]}} {{pair_one=@{pair_one}}} {{pair_two=@{pair_two}}} {{pair_three=@{pair_three}}} {{pair_four=@{pair_four}}} {{pair_five=@{pair_five}}} {{pair_six=@{pair_six}}} {{pair_of_one=[[1d6]]}} {{pair_of_two=[[1d6]]}} {{pair_of_three=[[1d6]]}} {{pair_of_four=[[1d6]]}} {{pair_of_five=[[1d6]]}} {{pair_of_six=[[1d6]]}}';
        startRoll(roll, (results) => {
            const dices	= results.results.dices.dice;
			var table = [0,0,0,0,0,0,0];

			for (i = 0; dices.length > i; i++) {
				table[dices[i]] += 1;
			}

			const pairs = ["pair_one", "pair_two", "pair_three", "pair_four", "pair_five", "pair_six"];

			pairs.forEach((pair, index) => {
				getAttrs([pair], values => {
					setAttrs({ 
						[`${pair}`]: table[index+1]
					});
				});
			});

            finishRoll(
                results.rollId,
                {
                    pair_of_one: table[1],
                    pair_of_two: table[2],
                    pair_of_three: table[3],
                    pair_of_four: table[4],
                    pair_of_five: table[5],
                    pair_of_six: table[6],
                }
            );
        });
    });
</script>
