<div class="character-sheet">

    <div class="row">
        <div class="col-8 character-details">

            <div class="flex">
                <label>I am</label>
                <input type="text" class="transparent" name="attr_character_name" title="@{character_name}" spellcheck="false">
            </div>

            <div class="flex">
                <label>Call me if you need a</label>
                <input type="text" class="transparent">
            </div>

            <div class="flex center-inputs">
                <label>Place I call home</label>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Heritage</p>
                </div>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Homeland</p>
                </div>
                <div class="input-with-subtext">
                    <input type="text" class="transparent">
                    <p>Workplace</p>
                </div>
            </div>

            <div class="input-with-subtext center-inputs">
                <input type="text" class="transparent">
                <p>Words to live by</p>
            </div>

            <br><br>

            <label class="secret-roll"><input type="checkbox" value="/w gm" name="attr_secret_roll"> <span data-i18n="make-the-roll-secret">Make the roll secret</span></label>
        </div>
        <div class="col-4">
            <input type="text">
        </div>
    </div>

    <div class="row">
        <div class="col-4">
            <div class="attribute-box">
                <div class="attribute-label">


                    <button type="action" name="act_roll" data-i18n="action" data-attribute="action" data-skill="">Action</button>

                    <input type="hidden" name="attr_action_calc" value="0">
                    <div class="diamond-checkboxes">
                        <input class="diamond-input" type="checkbox" name="attr_action" id="action_value_3" value="3" />
                        <label class="diamond-checkbox" for="action_value_3">
                            <span class="icon-diamond"></span>
                        </label>

                        <input class="diamond-input" type="checkbox" name="attr_action" id="action_value_2" value="2" />
                        <label class="diamond-checkbox diamond-up" for="action_value_2">
                            <span class="icon-diamond"></span>
                        </label>

                        <input class="diamond-input" type="checkbox" name="attr_action" id="action_value_1" value="1" />
                        <label class="diamond-checkbox" for="action_value_1">
                            <span class="icon-diamond"></span>
                        </label>
                    </div>
                </div>
                <div class="skill-box">
                    <div class="skill-label">
						<button type="action" name="act_roll" data-i18n="fight" data-attribute="action" data-skill="fight">Fight</button>

                        <input type="hidden" name="attr_fight_calc" value="0">
                        <div class="diamond-checkboxes">
                            <input class="diamond-input" type="checkbox" name="attr_fight" id="fight_value_3" value="3" />
                            <label class="diamond-checkbox" for="fight_value_3">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_fight" id="fight_value_2" value="2" />
                            <label class="diamond-checkbox diamond-up" for="fight_value_2">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_fight" id="fight_value_1" value="1" />
                            <label class="diamond-checkbox" for="fight_value_1">
                                <span class="icon-diamond"></span>
                            </label>
                        </div>
                    </div>

                    <div class="skill-label">
						<button type="action" name="act_roll" data-i18n="leadership" data-attribute="action" data-skill="leadership">Leadership</button>

                        <input type="hidden" name="attr_leadership_calc" value="0">
                        <div class="diamond-checkboxes">
                            <input class="diamond-input" type="checkbox" name="attr_leadership" id="leadership_value_3" value="3" />
                            <label class="diamond-checkbox" for="leadership_value_3">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_leadership" id="leadership_value_2" value="2" />
                            <label class="diamond-checkbox diamond-up" for="leadership_value_2">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_leadership" id="leadership_value_1" value="1" />
                            <label class="diamond-checkbox" for="leadership_value_1">
                                <span class="icon-diamond"></span>
                            </label>
                        </div>
                    </div>

                    <div class="skill-label">
                        <button type="action" name="act_roll" data-i18n="stunt" data-attribute="action" data-skill="stunt">Stunt</button>

                        <input type="hidden" name="attr_stunt_calc" value="0">
                        <div class="diamond-checkboxes">
                            <input class="diamond-input" type="checkbox" name="attr_stunt" id="stunt_value_3" value="3" />
                            <label class="diamond-checkbox" for="stunt_value_3">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_stunt" id="stunt_value_2" value="2" />
                            <label class="diamond-checkbox diamond-up" for="stunt_value_2">
                                <span class="icon-diamond"></span>
                            </label>

                            <input class="diamond-input" type="checkbox" name="attr_stunt" id="stunt_value_1" value="1" />
                            <label class="diamond-checkbox" for="stunt_value_1">
                                <span class="icon-diamond"></span>
                            </label>
                        </div>
                    </div>

                    <input type="text" name="attr_action_modifier" value="0">
                    
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="attr_pair_one" value="0">
    <input type="hidden" name="attr_pair_two" value="0">
    <input type="hidden" name="attr_pair_three" value="0">
    <input type="hidden" name="attr_pair_four" value="0">
    <input type="hidden" name="attr_pair_five" value="0">
    <input type="hidden" name="attr_pair_six" value="0">

    <input type="hidden" name="attr_null_calc" value="0">
</div>



<!-- Roll Templates -->

<rolltemplate class="sheet-rolltemplate-brokencompass">

    <h4>dices = {{dices}}</h4>

	<div class="template-wrap">
		<div class="template-header">
			{{#character_name}}
			{{#character_id}}[{{character_name}}](https://journal.roll20.net/character/{{character_id}}){{/character_id}}
			{{^character_id}}{{character_name}}{{/character_id}}
			{{/character_name}}
		</div>

        <div class="template-subtitle">
            {{roll-name}}
        </div>

        <div class="template-grid-item-flex">
		    <label class="template-label">Total dices:</label>
            <div class="template-roll-between">{{baseDice}}</div>
        </div>

        <div class="template-grid-item-flex">
            <label class="template-label">Equal dice:</label>
        </div>

        <div class="template-grid-item-box">
            {{#rollGreater() computed::pair_of_one 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                {{#rollGreater() computed::pair_of_one 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                {{/rollGreater() computed::pair_of_one 2}}

                {{#rollGreater() computed::pair_of_one 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                {{/rollGreater() computed::pair_of_one 3}}

                {{#rollGreater() computed::pair_of_one 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                {{/rollGreater() computed::pair_of_one 4}}

                {{#rollGreater() computed::pair_of_one 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">1</span></div>
                {{/rollGreater() computed::pair_of_one 5}}

            </div>
            {{/rollGreater() computed::pair_of_one 1}}

            {{#rollGreater() computed::pair_of_two 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">2</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">2</span></div>

                {{#rollGreater() computed::pair_of_two 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">2</span></div>
                {{/rollGreater() computed::pair_of_two 2}}

                {{#rollGreater() computed::pair_of_two 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">2</span></div>
                {{/rollGreater() computed::pair_of_two 3}}

                {{#rollGreater() computed::pair_of_two 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">2</span></div>
                {{/rollGreater() computed::pair_of_two 4}}

                {{#rollGreater() computed::pair_of_two 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">2</span></div>
                {{/rollGreater() computed::pair_of_two 5}}
            </div>
            {{/rollGreater() computed::pair_of_two 1}}

            {{#rollGreater() computed::pair_of_three 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">3</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">3</span></div>

                {{#rollGreater() computed::pair_of_three 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">3</span></div>
                {{/rollGreater() computed::pair_of_three 2}}

                {{#rollGreater() computed::pair_of_three 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">3</span></div>
                {{/rollGreater() computed::pair_of_three 3}}

                {{#rollGreater() computed::pair_of_three 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">3</span></div>
                {{/rollGreater() computed::pair_of_three 4}}

                {{#rollGreater() computed::pair_of_three 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">3</span></div>
                {{/rollGreater() computed::pair_of_three 5}}
            </div>
            {{/rollGreater() computed::pair_of_three 1}}

            {{#rollGreater() computed::pair_of_four 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">4</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">4</span></div>

                {{#rollGreater() computed::pair_of_four 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">4</span></div>
                {{/rollGreater() computed::pair_of_four 2}}

                {{#rollGreater() computed::pair_of_four 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">4</span></div>
                {{/rollGreater() computed::pair_of_four 3}}

                {{#rollGreater() computed::pair_of_four 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">4</span></div>
                {{/rollGreater() computed::pair_of_four 4}}

                {{#rollGreater() computed::pair_of_four 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">4</span></div>
                {{/rollGreater() computed::pair_of_four 5}}

            </div>
            {{/rollGreater() computed::pair_of_four 1}}

            {{#rollGreater() computed::pair_of_five 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">5</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">5</span></div>

                {{#rollGreater() computed::pair_of_five 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">5</span></div>
                {{/rollGreater() computed::pair_of_five 2}}

                {{#rollGreater() computed::pair_of_five 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">5</span></div>
                {{/rollGreater() computed::pair_of_five 3}}

                {{#rollGreater() computed::pair_of_five 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">5</span></div>
                {{/rollGreater() computed::pair_of_five 4}}

                {{#rollGreater() computed::pair_of_five 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">5</span></div>
                {{/rollGreater() computed::pair_of_five 5}}
            </div>
            {{/rollGreater() computed::pair_of_five 1}}

            {{#rollGreater() computed::pair_of_six 1}}
            <div class="template-grid-item">
                <div class="template-roll-between"><span class="template-roll-dice">6</span></div>
                <div class="template-roll-between"><span class="template-roll-dice">6</span></div>

                {{#rollGreater() computed::pair_of_six 2}}
                    <div class="template-roll-between"><span class="template-roll-dice">6</span></div>
                {{/rollGreater() computed::pair_of_six 2}}

                {{#rollGreater() computed::pair_of_six 3}}
                    <div class="template-roll-between"><span class="template-roll-dice">6</span></div>
                {{/rollGreater() computed::pair_of_six 3}}

                {{#rollGreater() computed::pair_of_six 4}}
                    <div class="template-roll-between"><span class="template-roll-dice">6</span></div>
                {{/rollGreater() computed::pair_of_six 4}}

                {{#rollGreater() computed::pair_of_six 5}}
                    <div class="template-roll-between"><span class="template-roll-dice">6</span></div>
                {{/rollGreater() computed::pair_of_six 5}}
            </div>
            {{/rollGreater() computed::pair_of_six 1}}
        </div>

        <div class="template-grid-item-flex">
		    <label class="template-label">Basic:</label>
            <div class="template-roll-between">{{computed::basic_success}}</div>
        </div>

        <div class="template-grid-item-flex">
		    <label class="template-label">Critical:</label>
            <div class="template-roll-between">{{computed::critical_success}}</div>
        </div>

        <div class="template-grid-item-flex">
		    <label class="template-label">Extreme:</label>
            <div class="template-roll-between">{{computed::extreme_success}}</div>
        </div>

        <div class="template-grid-item-flex">
		    <label class="template-label">Impossible:</label>
            <div class="template-roll-between">{{computed::impossible_success}}</div>
        </div>
	</div>
</rolltemplate>

<script type="text/worker">


	const stats = ["action", "fight", "leadership", "stunt"];

	stats.forEach(stat => {
		on(`change:${stat}`, () => {
			getAttrs([stat], values => {
				const stat_base = values[stat]; 
				
				getAttrs([`${stat}_calc`], function(test) {
					setAttrs({
						[`${stat}_calc`]: stat_base
					}); 
				});
				
			});
		});
	});

	

    on('clicked:roll', (info) => {
		var attribute = info.htmlAttributes['data-attribute'];
		var skill = info.htmlAttributes['data-skill'];
		var rollName = attribute;

		if (skill == '') {
			skill = 'null';
		} else {
			rollName = skill;
		}

		const roll = '@{secret_roll} &{template:brokencompass} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{name=^{dice-pool}}} {{roll-name=^{'+rollName+'} }} {{baseDice=[[ @{'+attribute+'_calc} + @{'+skill+'_calc} + @{'+attribute+'_modifier} + ?{Modifiers|0} ]] }} {{dices=[[(@{'+attribute+'_calc} + @{'+skill+'_calc} + @{'+attribute+'_modifier} + ?{Modifiers|0})d6m]]}} {{pair_one=@{pair_one}}} {{pair_two=@{pair_two}}} {{pair_three=@{pair_three}}} {{pair_four=@{pair_four}}} {{pair_five=@{pair_five}}} {{pair_six=@{pair_six}}} {{pair_of_one=[[1d6]]}} {{pair_of_two=[[1d6]]}} {{pair_of_three=[[1d6]]}} {{pair_of_four=[[1d6]]}} {{pair_of_five=[[1d6]]}} {{pair_of_six=[[1d6]]}} {{basic_success=[[1d6]]}} {{critical_success=[[1d6]]}} {{extreme_success=[[1d6]]}} {{impossible_success=[[1d6]]}}';
        startRoll(roll, (results) => {
            const dices	= results.results.dices.dice;
			var table = [0,0,0,0,0,0,0];

            console.log(results)

			for (i = 0; dices.length > i; i++) {
				table[dices[i]] += 1;
			}

			const pairs = ["pair_one", "pair_two", "pair_three", "pair_four", "pair_five", "pair_six"];

			pairs.forEach((pair, index) => {
				getAttrs([pair], values => {
					setAttrs({ 
						[`${pair}`]: table[index+1]
					});
				});
			});

            var successes = {
                basic: 0,
                critical: 0,
                extreme: 0,
                impossible: 0,
            }

            for (k = 1; table.length > k; k++) {
                if (table[k] >= 5) {
                    successes.impossible += 1;
                } else if(table[k] == 4) {
                    successes.extreme += 1;
                } else if(table[k] == 3) {
                    successes.critical += 1;
                } else if(table[k] == 2) {
                    successes.basic += 1;
                }
            }

            finishRoll(
                results.rollId,
                {
                    pair_of_one: table[1],
                    pair_of_two: table[2],
                    pair_of_three: table[3],
                    pair_of_four: table[4],
                    pair_of_five: table[5],
                    pair_of_six: table[6],
                    basic_success: successes.basic,
                    critical_success: successes.critical,
                    extreme_success: successes.extreme,
                    impossible_success: successes.impossible,
                }
            );
        });
    });
</script>
