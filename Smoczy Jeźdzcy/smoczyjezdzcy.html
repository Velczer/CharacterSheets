<div class="character-sheet">
    <div class="row">
        <div class="col-12 center">
            <img src="https://raw.githubusercontent.com/Velczer/CharacterSheets/master/Smoczy%20Jeźdzcy/Images/logo.png" class="logo" alt="">
        </div>
    </div>
    <div class="row col-hr">
        <div class="col-6">
            <div>
                <h2 class="title" data-i18n="dragon-rider">Smoczy jeździec</h2>
                <div class="input-with-label">
                    <label data-i18n="name">Imię</label>
                    <input type="text" name="attr_character_name">
                </div>
    
                <div class="input-with-label">
                    <label data-i18n="nickname">Przydomek</label>
                    <input type="text" name="attr_nickname">
                </div>
    
                <div class="input-with-label">
                    <label data-i18n="archetype">Archetyp</label>
                    <select name="attr_achertype">
                        <option value="pick" data-i18n="pick" selected>Wybierz</option>
                        <option value="hero" data-i18n="hero">Bohaterka</option>
                        <option value="aristocrat" data-i18n="aristocrat">Arystokrata</option>
                        <option value="rebel" data-i18n="rebel">Buntowniczka</option>
                        <option value="dodger" data-i18n="dodger">Spryciarz</option>
                        <option value="hunter" data-i18n="hunter">Łowczyni</option>
                        <option value="sage" data-i18n="sage">Mędrzec</option>
                        <option value="fraud" data-i18n="fraud">Oszustka</option>
                        <option value="avenger" data-i18n="avenger">Mściciel</option>
                        <option value="alumnus-of-order" data-i18n="alumnus-of-order">Wychowanka Zakonu</option>
                    </select>
                </div>
    
                <div class="input-with-label">
                    <label data-i18n="age">Wiek / Staż</label>
                    <input type="text" name="attr_age">
                </div>
    
                <div class="input-with-label">
                    <label data-i18n="motivation">Motywacja</label>
                    <select name="attr_motivation">
                        <option value="pick-or-enter" data-i18n="pick-or-enter" selected>Wybierz lub wpisz</option>
                        <option value="faith-in-aslaug" data-i18n="faith-in-aslaug">Wiara w Aslauga</option>
                        <option value="hatred-of-chimeras" data-i18n="hatred-of-chimeras">Nienawiść do chimer</option>
                        <option value="desire-for-fame" data-i18n="desire-for-fame">Pragnienie sławy</option>
                        <option value="good-of-empire" data-i18n="good-of-empire">Dobro ludzi Imperium</option>
                        <option value="private-interests" data-i18n="private-interests">Prywatne interesy</option>
                        <option value="desire-for-adventure" data-i18n="desire-for-adventure">Pragnienie przygód</option>
                        <option value="gratitude" data-i18n="gratitude">Wdzięczność</option>
                        <option value="call-of-duty" data-i18n="call-of-duty">Poczucie obowiązku</option>
                        <option value="desire-for-revenge" data-i18n="desire-for-revenge">Żądza zemsty</option>
                        <option value="penance" data-i18n="penance">Pokuta</option>
                        <option value="feeling-guilty" data-i18n="feeling-guilty">Poczucie winy</option>
                        <option value="desire-for-power" data-i18n="desire-for-power">Pragnienie władzy</option>
                    </select>
                    <input type="text" name="attr_motivation_text">
                </div>
            </div>
            
            <div class="margin-20"></div>

            <div class="sygnet-background__wrapper">
                <div class="sygnet-background" style="left: -220px; top: 20px;"></div>

                <label class="checkbox-label small-checkbox" style="position: absolute; right:0">
                    <input type="hidden" name="attr_dragon_presence" value="0">
                    <input type="checkbox" name="attr_dragon_presence" value="1">
                    <span data-i18n="dragon-presence">Obecność smoka</span>
                </label>
            </div>

            <div class="attr-row__wrapper" style="margin-left: 20px;">
                <h3 class="subtitle" data-i18n="bravery">Waleczność</h3>

                <div class="attr-row" style="margin-left: 30px;">
                    <div class="main-attr">
                        <input type="hidden" name="attr_bravery_calc" value="0">
                        <label class="checkbox-label">
                            <input type="radio" name="attr_connection_attr" value="bravery">
                        </label>
                        <input type="number" name="attr_bravery" value="0">
                    </div>
    
                    <div class="flex-column">
                        <div class="attr-label">
                            <input type="number" name="attr_willpower" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{willpower}}}' data-main-attribute="bravery" data-attribute="willpower" data-i18n="willpower">Siła Woli</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_fight" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{fight}}}' data-main-attribute="bravery" data-attribute="fight" data-i18n="fight">Walka</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_resilence" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{resilence}}}' data-main-attribute="bravery" data-attribute="resilence" data-i18n="resilence">Wytrzymałość</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="attr-row__wrapper" style="margin-left: 90px;">
                <h3 class="subtitle" data-i18n="flair">Spryt</h3>
                <div class="attr-row">
                    <div class="main-attr">
                        <input type="hidden" name="attr_flair_calc" value="0">
                        <label class="checkbox-label">
                            <input type="radio" name="attr_connection_attr" value="flair">
                        </label>
                        <input type="number" name="attr_flair" value="0">
                    </div>
    
                    <div class="flex-column">
                        <div class="attr-label">
                            <input type="number" name="attr_cunning" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{cunning}}}' data-main-attribute="flair" data-attribute="cunning" data-i18n="cunning">Przebiegłość</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_observation" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{observation}}}' data-main-attribute="flair" data-attribute="observation" data-i18n="observation">Spostrzegawczość</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_dexterity" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{dexterity}}}' data-main-attribute="flair" data-attribute="dexterity" data-i18n="dexterity">Zręczność</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="attr-row__wrapper" style="margin-left: 120px;">
                <h3 class="subtitle" data-i18n="wisdom">Mądrość</h3>
                <div class="attr-row">
                    <div class="main-attr">
                        <input type="hidden" name="attr_wisdom_calc" value="0">
                        <label class="checkbox-label">
                            <input type="radio" name="attr_connection_attr" value="wisdom">
                        </label>
                        <input type="number" name="attr_wisdom" value="0">
                    </div>
    
                    <div class="flex-column">
                        <div class="attr-label">
                            <input type="number" name="attr_magic_arena" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{magic-arena}}}' data-main-attribute="wisdom" data-attribute="magic_arena" data-i18n="magic-arena">Arena Magii</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_perspicacity" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{perspicacity}}}' data-main-attribute="wisdom" data-attribute="perspicacity" data-i18n="perspicacity">Arena Magii</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_understanding" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{understanding}}}' data-main-attribute="wisdom" data-attribute="understanding" data-i18n="understanding">Rozumienie</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="attr-row__wrapper" style="margin-left: 70px;">
                <h3 class="subtitle" data-i18n="sophistication">Obycie</h3>
                <div class="attr-row">
                    <div class="main-attr">
                        <input type="hidden" name="attr_sophistication_calc" value="0">
                        <label class="checkbox-label">
                            <input type="radio" name="attr_connection_attr" value="sophistication">
                        </label>
                        <input type="number" name="attr_sophistication" value="0">
                    </div>
    
                    <div class="flex-column">
                        <div class="attr-label">
                            <input type="number" name="attr_history" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{history}}}' data-main-attribute="sophistication" data-attribute="history" data-i18n="history">Historia</button>

                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_inspiration" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{inspiration}}}' data-main-attribute="sophistication" data-attribute="inspiration" data-i18n="inspiration">Inspiracja</button>
                        </div>
                        <div class="attr-label">
                            <input type="number" name="attr_persuasion" value="0">
                            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{persuasion}}}' data-main-attribute="sophistication" data-attribute="persuasion" data-i18n="persuasion">Przekonywanie</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="margin-20"></div>

            <h3 class="subtitle" data-i18n="talents">Talenty</h3>
            <div class="fieldset-labels">
                <span class="flex-1 mini-title" data-i18n="talent-name">Nazwa talentu</span>
                <span class="flex-4 mini-title" data-i18n="description">Opis</span>
            </div>
            <fieldset class="repeating_talents">
                <input class="flex-1" type="text" name="attr_talent_name">
                <textarea class="flex-4" name="attr_talent_desc" rows="2"></textarea>
            </fieldset>
        </div>

        <div class="col-6 sygnet-background__wrapper">
            <div class="sygnet-background" style="right: -130px;top:50px"></div>
            <div class="row">
                <div class="col-8">
                    <h2 class="title" data-i18n="dragon">Smok</h2>
                    <div class="input-with-label">
                        <label data-i18n="name">Imię</label>
                        <input type="text" name="attr_dragon_name">
                    </div>

                    <div class="input-with-label">
                        <label data-i18n="character">Charakter</label>
                        <input type="text" name="attr_dragon_character">
                    </div>

                    <div class="input-with-label">
                        <label data-i18n="archetype">Archetyp</label>
                        <select name="attr_dragon_archetype">
                            <option value="pick" data-i18n="pick" selected>Wybierz</option>
                            <option value="dream-dragon" data-i18n="dream-dragon">Twój Wymarzony Smok</option>
                            <option value="majestic-giant" data-i18n="majestic-giant">Majestatyczny Olbrzym</option>
                            <option value="terror-from-space" data-i18n="terror-from-space">Terror z Przestworzy</option>
                            <option value="gentle-beauty" data-i18n="gentle-beauty">Łagodna Piękność</option>
                            <option value="insidious-predator" data-i18n="insidious-predator">Podstępny Drapieżca</option>
                            <option value="dark-secret" data-i18n="dark-secret">Mroczna Tajemnica</option>
                            <option value="winged-trouble" data-i18n="winged-trouble">Skrzydlate Tarapaty</option>
                            <option value="repository-of-knowledge" data-i18n="repository-of-knowledge">Skarbnica Wiedzy</option>
                            <option value="untamed-beast" data-i18n="untamed-beast">Nieokiełznana Bestia</option>
                        </select>
                    </div>

                    <div class="input-with-label">
                        <label data-i18n="relation">Relacja</label>
                        <select name="attr_dragon_relation">
                            <option value="pick" data-i18n="pick" selected>Wybierz</option>
                            <option value="guardian" data-i18n="guardian">Opiekun</option>
                            <option value="rival" data-i18n="rival">Rywalka</option>
                            <option value="friend" data-i18n="friend">Przyjaciel</option>
                            <option value="siblings" data-i18n="siblings">Rodzeństwo</option>
                            <option value="subordinate" data-i18n="subordinate">Podwładny</option>
                            <option value="mentor" data-i18n="mentor">Mentorka</option>
                            <option value="beloved" data-i18n="beloved">Ukochana</option>
                            <option value="despot" data-i18n="despot">Despota</option>
                            <option value="problem" data-i18n="problem">Problem</option>
                        </select>
                    </div>

                    <div class="input-with-label">
                        <label data-i18n="size">Wielkość</label>
                        <input type="text" name="attr_dragon_size">
                    </div>

                </div>
                <div class="col-4">
                    <h3 class="subtitle" data-i18n="level-of-connection">Poziom Więzi</h3>

                    <div class="attr-row" style="justify-content: flex-start;">
                        <div class="main-attr">
                            <input type="number" name="attr_level_of_connection" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="margin-20"></div>

            <h3 class="subtitle" data-i18n="connection-cost">Cena Więzi</h3>
            <textarea name="attr_connection_cost" rows="3"></textarea>

            <h3 class="subtitle" data-i18n="aslaug-words">Słowa Aslauga</h3>
            <textarea name="attr_aslaug_words" rows="3"></textarea>

            <div class="margin-20"></div>

            <h3 class="subtitle" data-i18n="dragon-powers">Moce smoka</h3>
            <div class="fieldset-labels">
                <span class="flex-3 mini-title" data-i18n="dragon-power-name">Nazwa</span>
                <span class="flex-1 mini-title" data-i18n="dragon-power-lvl">Poziom</span>
                <span class="flex-4 mini-title" data-i18n="description">Opis</span>
            </div>
            <fieldset class="repeating_dragonpowers">
                <input class="flex-3" type="text" name="attr_dragon_power_name">
                <input class="flex-1" type="number" name="attr_dragon_power_lvl" value="0">
                <textarea class="flex-4" name="attr_dragon_power_desc" rows="2"></textarea>
            </fieldset>
            
        </div>
    </div>

    <div class="margin-20"></div>

    <div class="row">
        <div class="col-4">
            <h3 class="subtitle" data-i18n="zest">Animusz</h3>
            <div class="inputs-box">
                <input type="number" name="attr_zest_lvl">
                <input type="text" name="attr_zest_desc">
            </div>

            <div class="margin-10"></div>

            <h3 class="subtitle" data-i18n="throws">Rzuty</h3>

            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{combat}}}' data-main-attribute="bravery" data-attribute="fight" data-i18n="combat">Zwarcie</button>

            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{range}}}' data-main-attribute="flair" data-attribute="dexterity" data-i18n="range">Dystans</button>

            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{baseRoll=[[@{level_of_connection}d6 + @{dragon_presence}d8 + ?{@{d6modifier}|0}d6 ]]}} {{roll-name=^{dodge}}}' data-attribute="dodge" data-main-attribute="baseroll" data-i18n="dodge">Unik</button>

            <button class="label-roll" type="action" name="act_roll" value='&{template:dragonriders} {{roll-name=^{bond}}}' data-attribute="bond" data-main-attribute="bond" data-i18n="bond">Więź</button>

            <div class="margin-10"></div>

            <h3 class="subtitle" data-i18n="experience-points">Punkty Doświadczenia</h3>
            <input type="text" name="attr_experience" class="input-with-border" style="width: 100%;">
        </div>

        <div class="col-4">
            <table class="states-table">
                <thead>
                    <tr>
                        <th data-i18n="rider">Jeździec</th>
                        <th data-i18n="states" class="states-table__main-title">Stany</th>
                        <th data-i18n="dragon">Smok</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_scratched" value="1">
                                <span></span>
                            </label>
                        </td>
                        <td data-i18n="scratched">Draśnięty</td>
                        <td>
                            <div class="double-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_scratched_1" value="1">
                                    <span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_scratched_2" value="1">
                                    <span></span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_battered" value="1">
                                <span></span>
                            </label>
                        </td>
                        <td data-i18n="battered">Poturbowany</td>
                        <td>
                            <div class="double-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_battered_1" value="1">
                                    <span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_battered_2" value="1">
                                    <span></span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_injured" value="1">
                                <span></span>
                            </label>
                        </td>
                        <td data-i18n="injured">Ranny</td>
                        <td>
                            <div class="double-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_injured_1" value="1">
                                    <span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_injured_2" value="1">
                                    <span></span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_massacred" value="1">
                                <span></span>
                            </label>
                        </td>
                        <td data-i18n="massacred">Zmasakrowany</td>
                        <td>
                            <div class="double-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_massacred_1" value="1">
                                    <span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="attr_dragon_massacred_2" value="1">
                                    <span></span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_dead" value="1">
                                <span>M</span>
                            </label>
                        </td>
                        <td data-i18n="dead">Martwy</td>
                        <td>
                            <label class="checkbox-label">
                                <input type="checkbox" name="attr_dragon_dead" value="1">
                                <span>M</span>
                            </label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="col-4">
            <h3 class="subtitle" data-i18n="dragon-look">Opis wyglądu</h3>
            <textarea name="attr_dragon_look" rows="10"></textarea>
        </div>
    </div>

    <div class="margin-20"></div>

    <div class="row">
        <div class="col-6">
            <h3 class="subtitle center">Twoja prowincja</h3>
            <textarea name="attr_province" rows="10"></textarea>
        </div>
        <div class="col-6">
            <h3 class="subtitle center">Twoje skrzydło</h3>
            <textarea name="attr_wing" rows="10"></textarea>
        </div>
    </div>

    <div class="margin-20"></div>

    <div class="row">
        <div class="col-12">
            <h3 class="subtitle center" data-i18n="chessboard-mode">Tryb szachownicy</h3>
        </div>
    </div>

    <div class="row">
        <div class="col-9">
            <div class="input-with-label">
                <label data-i18n="personal-goal">Cel osobisty</label>
                <input type="text" name="attr_personal_goal">
            </div>
        </div>
        <div class="col-3">
            <div class="attr-row" style="justify-content: flex-start;">
                <div class="attr-label">
                    <label data-i18n="influence-points">Punkty Wpływu</label>
                    <input type="number" name="attr_influence_points" value="0">
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Roll Templates -->
<rolltemplate class="sheet-rolltemplate-dragonriders">
	<div class="template-wrap">
		<div class="template-header">
            <span>
                {{#character_name}}
                {{#character_id}}[{{character_name}}](https://journal.roll20.net/character/{{character_id}}){{/character_id}}
                {{^character_id}}{{character_name}}{{/character_id}}
                {{/character_name}}
            </span>
		</div>
        
        <div class="template-roll-results-title">{{roll-name}}</div>


        <div class="template-roll-success-small-text" data-i18n="amount-of-success">Liczba sukcesów:</div>
        <div class="template-roll-results">
            <div class="template-circle"><span class="template-base-roll">{{baseRoll}}</span> <span class="template-roll-success">{{computed::success}}</span></div>
        </div>

        <div class="template-dragon-presence">
            <div>
                {{#rollBetween() computed::connectionWithDragon 1 1}}
                <div class="template-roll-results-small-text" data-i18n="connection-with-dragon">Więź ze smokiem</div>
                {{/rollBetween() computed::connectionWithDragon 1 1}}
            </div>

            <div>
                {{#rollBetween() dragonPresence 1 1}}
                <div class="template-roll-results-small-text" data-i18n="dragon-presence">Obecność smoka</div>
                {{/rollBetween() dragonPresence 1 1}}
            </div>
        </div>

	</div>
</rolltemplate>


<script type="text/worker">
    on("sheet:opened", function(eventInfo){
        setAttrs({
            d6modifier: getTranslationByKey("d6modifier")
        });     
    });

    on('clicked:roll', async (event) => {
        var mainAttribute = event.htmlAttributes['data-main-attribute'];

        if (mainAttribute == 'baseroll') {
            var rollBase = event.htmlAttributes.value + "{{character_name=@{character_name}}} {{character_id=@{character_id}}} {{success=[[0]]}} {{dragonPresence=[[@{dragon_presence}]]}} {{connectionWithDragon=[[0]]}}";

        } else if (mainAttribute == 'bond') {
            var connectionAttr = await asw.getAttrs(['connection_attr']);
            connectionAttr = Object.values(connectionAttr)[0];

            console.log(connectionAttr)

            var mainAttributeNum = await asw.getAttrs([connectionAttr]);

            console.log(mainAttributeNum)
            mainAttributeNum = Number(Object.values(mainAttributeNum)[0]);

            console.log(mainAttributeNum)

            var rollBase = event.htmlAttributes.value + "{{baseRoll=[[ "+mainAttributeNum+"d6 + @{level_of_connection}d6 + ?{@{d6modifier}|0}d6 ]]}} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{success=[[0]]}} {{dragonPresence=[[@{dragon_presence}]]}} {{connectionWithDragon=[[0]]}}";

        } else {
            var attribute = event.htmlAttributes['data-attribute'];

            var mainAttributeNum = await asw.getAttrs([mainAttribute]);
            mainAttributeNum = Number(Object.values(mainAttributeNum)[0]);
    
            var attributeNum = await asw.getAttrs([attribute]);
            attributeNum = Number(Object.values(attributeNum)[0]);
    
            var d6 = mainAttributeNum + attributeNum;
            var d8 = 0;
    
            var connectionAttr = await asw.getAttrs(['connection_attr']);
            connectionAttr = Object.values(connectionAttr);
    
            var dragonPresence = await asw.getAttrs(['dragon_presence']);
            dragonPresence = Number(Object.values(dragonPresence)[0]);
    
            d8 += dragonPresence;
    
            var connectionWithDragon = connectionAttr[0] == mainAttribute ? 1 : 0;
            if (connectionWithDragon == 1) {
                var levelOfConnection = await asw.getAttrs(['level_of_connection']);
                levelOfConnection = Number(Object.values(levelOfConnection)[0]);
    
                d6 -= levelOfConnection;
    
                if (dragonPresence == 1) {
                    d8 += levelOfConnection;
                }
            }
    
            var rollBase = event.htmlAttributes.value + "{{baseRoll=[[ "+d6+"d6 + "+d8+"d8 + ?{@{d6modifier}|0}d6 ]]}} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{success=[[0]]}} {{dragonPresence=[[@{dragon_presence}]]}} {{connectionWithDragon=[["+connectionWithDragon+"]]}}";
        }

        let rollResult = await startRoll(rollBase);

        console.log(rollResult)

        let computedValues = await calcComputedValues(rollResult);

        if (mainAttribute != 'baseroll') {
            computedValues.connectionWithDragon = connectionWithDragon;
        }

        console.log(computedValues)
    
        finishRoll(
            rollResult.rollId,
            computedValues
        );
    });

    const calcComputedValues = async (rollResult) => {
        var results = rollResult.results;

        var dices = results.baseRoll.dice
        var success = 0;
        for (var i = 0; i < dices.length; i++) {
            if (dices[i] == 6 || dices[i] == 7) {
                success++
            } else if (dices[i] == 8 || dices[i] == 9) {
                success += 2
            } else if (dices[i] >= 10) {
                success += 3
            }
        }

        let computedValues = {
            success: success,
        };

        return computedValues;
    };

    // Get attr helper
    const asw = (() => {
        const setActiveCharacterId = function(charId){
            let oldAcid=getActiveCharacterId();
            let ev = new CustomEvent("message");
            ev.data={"id":"0", "type":"setActiveCharacter", "data":charId};
            self.dispatchEvent(ev);
            return oldAcid;
        };
        const promisifyWorker = (worker, parameters) => {
            let acid=getActiveCharacterId();
            let prevAcid=null;
            return new Promise((res,rej)=>{
                prevAcid=setActiveCharacterId(acid);
                try {if (worker===0) getAttrs(parameters[0]||[],(v)=>res(v));
                    else if (worker===1) setAttrs(parameters[0]||{}, parameters[1]||{},(v)=>res(v));
                    else if (worker===2) getSectionIDs(parameters[0]||'',(v)=>res(v));
                } catch(err) {rej(console.error(err))}
            }).finally(()=>setActiveCharacterId(prevAcid));
        }
        
        return {
            getAttrs(attrArray) {return promisifyWorker(0, [attrArray])},
            setAttrs(attrObj, options) {return promisifyWorker(1, [attrObj, options])},
            getSectionIDs(section) {return promisifyWorker(2, [section])},
            setActiveCharacterId,
        }
    })();

</script>
